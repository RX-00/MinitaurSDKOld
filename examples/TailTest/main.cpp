
#include <stdio.h>
#include <SDK.h>
#include <math.h>
#include <Motor.h>
#include <ReorientableBehavior.h>
#include "Interpolator.h"

#if defined(ROBOT_MINITAUR)
// Subject to change for individual robots
// const float motZeros[8] = {2.82, 3.435, 3.54, 3.076, 1.03, 3.08, 6.190, 1.493};
// const float motZeros[8] = {2.570, 2.036, 3.777, 3.853, 2.183, 1.556, .675, 2.679}; // RML Ellie
const float motZeros[8] = {1.010, 2.036, 3.777, 3.853, 2.183, 1.556, .675, 1.010}; // RML Ellie With Tail
// const float motZeros[8] = {0.631, 4.076, 1.852, 3.414, 1.817, 5.500, 1.078, 6.252}; //RML Odie
// const float motZeros[9] = {0.631, 4.076, 1.852, 3.414, 1.817, 5.500, 1.078, 6.252, 1.010}; //RML Odie with Tail
// const float motZeros[1] = {1.010}; //RML Odie with just Tail

#endif


#define TIMESTEPS 81
#define MOTORS 8 
#define TAIL_MOT 0

char myData[32];
float* myData_buf = (float*)myData;

enum TBMode
{
	TB_SIT = 0,
	TB_STAND,
};

float times[TIMESTEPS] = {0.000000,0.001909,0.003817,0.005726,0.007634,0.009543,0.011452,0.013360,0.015269,0.017178,0.019086,0.020995,0.022904,0.024812,0.026721,0.028629,0.030538,0.032447,0.034355,0.036264,0.038172,0.040081,0.041990,0.043898,0.045807,0.047716,0.049624,0.051533,0.053441,0.055350,0.057259,0.059167,0.061076,0.062985,0.064893,0.066802,0.068710,0.070619,0.072528,0.074436,0.076345,0.078254,0.080162,0.082071,0.083979,0.085888,0.087797,0.089705,0.091614,0.093523,0.095431,0.097340,0.099248,0.101157,0.103066,0.104974,0.106883,0.108792,0.110700,0.112609,0.114517,0.116426,0.118335,0.120243,0.122152,0.124061,0.125969,0.127878,0.129787,0.131695,0.133604,0.135512,0.137421,0.139330,0.141238,0.143147,0.145056,0.146964,0.148873,0.150781,0.152690};
float pos[TIMESTEPS][MOTORS] = {{-0.505013,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.502564,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.499069,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.494586,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.489844,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.484714,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.479734,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.474546,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.469571,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.464608,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.459475,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.454596,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.449597,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.444903,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.440137,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.435724,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.431286,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.427247,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.423223,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.419633,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.416086,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.412989,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.409946,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.407356,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.404821,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.402740,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.400712,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.399036,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.397404,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.396211,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.395049,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.394313,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.393599,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.393303,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.393033,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.393234,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.393440,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.393539,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.394087,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.395990,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.399168,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.403324,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.407668,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.412414,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.417063,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.421977,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.426724,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.431473,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.436398,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.441080,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.445898,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.450432,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.455067,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.459393,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.463806,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.467905,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.472086,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.475947,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.479874,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.483446,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.487045,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.490252,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.493453,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.496234,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.498982,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.501282,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.503528,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.505317,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.507049,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.508323,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.509539,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.510297,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.510995,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.511234,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.511414,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.511135,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.510797,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.509999,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.509143,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.507835,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.506452,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000}};
float vel[TIMESTEPS][MOTORS] = {{0.856431,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{1.620239,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.161577,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.463654,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.641712,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.677907,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.694785,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.689048,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.681383,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.673211,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.651564,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.615885,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.567681,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.506516,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.433048,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.346671,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.249217,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.139717,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.022522,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{1.896418,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{1.767477,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{1.634842,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{1.502086,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{1.368743,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{1.235641,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{1.102121,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.970369,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.839794,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.712921,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.590325,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.470363,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.353831,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.237514,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.123326,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.000240,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.145505,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.215205,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.120637,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.476330,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-1.411118,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.021492,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.267270,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.427447,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.490462,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.534885,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.559776,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.569311,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.562139,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.544688,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.516508,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.478359,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.428918,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.375028,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.315591,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.255884,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.195948,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.133080,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-2.068132,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-1.992713,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-1.906122,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-1.810845,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-1.706190,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-1.594580,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-1.475491,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-1.350165,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-1.217290,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-1.083626,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.948614,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.813726,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.678597,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.543344,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.407512,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.271848,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.135940,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.000257,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.135604,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.271254,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.407095,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.542740,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.674616,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.830156,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000}};
float dfVec[TIMESTEPS][MOTORS] = {{0.550419,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.757653,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.711543,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.793501,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.734120,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.743940,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.731549,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.729992,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.726011,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.723794,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.706013,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.696332,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.672170,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.655575,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.624753,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.601318,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.565052,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.535342,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.496656,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.462442,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.424785,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.388798,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.352465,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.316287,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.280179,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.243953,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.209541,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.174113,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.143052,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.109790,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.079682,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.048065,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.016855,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.014126,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.055062,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.094605,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.047446,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.021788,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.508280,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.761903,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.646190,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.712873,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.681933,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.699030,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.694743,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.701496,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.690547,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.688601,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.674730,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.667084,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.647866,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.634451,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.615748,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.599622,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.582964,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.566703,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.546883,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.529262,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.499507,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.476014,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.442422,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.414028,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.377509,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.345198,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.305587,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.269536,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.232387,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.195756,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.159073,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.122410,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.085418,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.048565,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.011723,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.025151,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.061944,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.098806,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.135596,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.172452,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.209247,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.245027,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.307889,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000}};
// float u[TIMESTEPS][MOTORS] = {{2.603584,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{2.603584,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{1.023832,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{1.023832,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.142274,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.142274,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.003355,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.003355,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.012210,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.012210,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.109686,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.109686,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.200416,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.200416,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.289554,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.289554,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.369983,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.369983,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.426376,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.426376,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.448266,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.448266,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.450845,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.450845,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.450804,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.450804,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.439880,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.439880,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.412365,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.412365,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.392396,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.392396,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.389538,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.389538,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.451265,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.451265,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.089578,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.089578,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-3.102827,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-3.102827,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.799984,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.799984,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.190960,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.190960,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.057200,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{-0.057200,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.053608,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.053608,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.128396,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.128396,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.200990,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.200990,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.234405,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.234405,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.238156,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.238156,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.260772,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.260772,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.336836,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.336836,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.400204,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.400204,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.451259,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.451259,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.497171,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.497171,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.504403,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.504403,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.505107,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.505107,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.507525,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.507525,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.507807,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.507807,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.507643,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.507643,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.507532,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.507532,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.507471,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.507471,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000},{0.676606,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000,0.000000}};

class TrajBound : public ReorientableBehavior
{
public:	

	Interpolator interp;

	TBMode mode = TB_SIT; //Current state within state-machine

	uint32_t tLast; //int used to store system time at various events

	float extDes;				 //The desired leg extension
	float angDes;				 // The desired leg angle
	float t;
	float test1;
	float test2;

	bool boolSlow = false;

	float posDes[MOTORS];
	float velDes[MOTORS];
	float accDes[MOTORS];
	float uDes[MOTORS];
	float df[MOTORS];
	float posAct;
	float velAct;
	float kp = 1;
	float kd = 0.025; // 0.02
	float kpt = 4;
	float kdt = 0.1; // 0.02
	float kpy = 0.1;//0.1;
	float kdy = 0;//0.05;
	float kiy = 0.02;
	float V = 16;
	float Ra = 0.23;
	float kt = 0.0954;
	float yawErrorInt = 0;

	float yawInit;
	float yawDes;
	float turnLeft;

	float finalTime = times[TIMESTEPS-1];


	//sig is mapped from remote; here, 3 corresponds to pushing the left stick to the right
	// which in turn forces the state machine into FH_LEAP
	void signal(uint32_t sig)
	{
		if(sig > 1)
		{
			tLast = S->millis;
		}
			
	}

	void begin()
	{
		mode = TB_STAND;			// Start behavior in STAND mode
		tLast = S->millis;		// Record the system time @ this transition
		yawInit = S->imu.euler.z;
		yawErrorInt = 0;
	}

	void update()
	{
		// if (isReorienting())
		// 	return;

		for (int j = 0; j < P->joints_count; j++)
	    {
	    	posDes[j] = 0;
	    	velDes[j] = 0;
	    	uDes[j] = 0;
	    	df[j] = 0;
	    }

		
		
		if (mode == TB_SIT)
		{
			C->mode = RobotCommand_Mode_JOINT;
			for (int i = 0; i < P->joints_count; i++)
			{
				posDes[i] = 0.5;
				// Splay angle for the front/rear legs (outward splay due to fore-displacement of front legs
				// and aft-displacement of rear legs)
				// The pitch angle (S->imu.euler.y) is subtracted since we want to the set the *absolute* leg angle
				// and limb[i].setPosition(ANGLE, *) will set the angle of the leg *relative* to the robot body
				
				if (i == TAIL_MOT)
				{
					posDes[i] = 0;
					joint[i].setGain(0.8, .003);
					joint[i].setPosition(posDes[i]);
				} else {
					if(i==1 || i==3 || i==4 || i==6)
					{
						posDes[i] = posDes[i] - S->imu.euler.y;
					}else if(i==0 || i==2 || i==5 || i==7)
					{
						posDes[i] = posDes[i] + S->imu.euler.y;
					}

					joint[i].setGain(0, 0);
					joint[i].setPosition(posDes[i]); 
				}

				
			}
		}
		else if (mode == TB_STAND)
		{
			C->mode = RobotCommand_Mode_JOINT;		

			t = 0.00001*(100*(S->millis - tLast) % (int)(100000*finalTime));

   		    interp.getMultipleCubicSplineInterp(pos,vel,times,t,posDes);
   		    interp.getMultipleLinearInterp(vel,times,t,velDes);
   		    interp.getMultipleZOH(dfVec,times,t,df);
   		    // interp.getMultipleZOH(u,times,t,accDes);

			for (int i = 0; i < P->joints_count; i++)
			{
				yawDes = yawInit + 0;
				yawErrorInt = yawErrorInt + 0.001*(yawDes - S->imu.euler.z);
				// turnLeft = kpy*(yawDes - S->imu.euler.z) + kdy*(-S->imu.angular_velocity.z) + 0.1;
				turnLeft = -map(C->behavior.twist.angular.z, -1.0, 1.0, -0.1, 0.1) + 0.03;

				if((i==0 || i==2 || i==4 || i==6) && (i != TAIL_MOT))
				{
					posDes[i] = posDes[i] - turnLeft;
				} else if((i==1 || i==3 || i==5 || i==7) && (i != TAIL_MOT))
				{
					posDes[i] = posDes[i] + turnLeft;
				}

				posAct = joint[i].getPosition();
				velAct = joint[i].getVelocity();


				// uDes[i] = accDes[i]*0.5*0.5*0.4/(45*0.7);
				// df[i] = 1/(0.95*V)*(uDes[i]*Ra/kt + kt*joint[i].getVelocity());

				if (i == TAIL_MOT)
				{
					// df[i] = 1/(0.95*V)*(uDes[i]*Ra/kt + kt*45*joint[i].getVelocity());
					joint[i].setOpenLoop(df[i] + kpt*(posDes[i] - posAct) + kdt*(velDes[i] - velAct));

				} else {
					// joint[i].setOpenLoop(df[i] + kp*(posDes[i] - posAct) + kd*(velDes[i] - velAct));
					joint[i].setOpenLoop(0.0);
				}
				
			}
		}
	}

	bool running()
	{
		return false;
	}
	void end()
	{
		mode = TB_SIT;
	}
};

TrajBound trajBound;

void debug()
{
	// printf("%d, ", trajBound.mode);
	// printf("Time: %4.3fs. ", trajBound.t);
	// printf("pos command: ");
	// for (int i = 0; i < P->joints_count; i++)
	// {
	// 	printf("%4.3f, ", joint[i].getOpenLoop());
	// }

	// printf("Pos: %4.3f, ", joint[TAIL_MOT].getPosition());
	// printf("Raw Pos: %4.3f, ",joint[TAIL_MOT].getRawPosition());
	
	// printf("%4.3f, %4.3f, %4.3f ", trajBound.yawInit,trajBound.turnLeft, trajBound.kiy*trajBound.yawErrorInt);
	// printf("\n");

	myData_buf[0] = joint[TAIL_MOT].getPosition();
	myData_buf[1] = joint[TAIL_MOT].getVelocity();
	myData_buf[2] = joint[TAIL_MOT].getOpenLoop();
	myData_buf[3] = trajBound.t;
	write(LOGGER_FILENO, myData, 32);
}

int main(int argc, char *argv[])
{
#if defined(ROBOT_MINITAUR)
	init(RobotParams_Type_MINITAUR, argc, argv);

		// Set the joint type; see JointParams
	P->joints[TAIL_MOT].type = JointParams_Type_GRBL;

	// Set the *physical* address (e.g. etherCAT ID, PWM port, dynamixel ID, etc.)
	P->joints[TAIL_MOT].address = 0;

	// If there is a gearbox the joint electronics doesn't know about, this could be > 1.
	// Do not set to 0.
	P->joints[TAIL_MOT].gearRatio = 45.39;

	// Configure joints
	P->joints_count = S->joints_count = C->joints_count = MOTORS;
	for (int i = 0; i < P->joints_count; i++)
	{
		// Set zeros and directions
		P->joints[i].zero = motZeros[i]; //Add motor zeros from array at beginning of file
	}
	P->joints[TAIL_MOT].direction = 1;
		
#elif defined(ROBOT_MINITAUR_E)
	init(RobotParams_Type_MINITAUR_E, argc, argv);
	JoyType joyType = JoyType_FRSKY_XSR;
	ioctl(JOYSTICK_FILENO, IOCTL_CMD_JOYSTICK_SET_TYPE, &joyType);
#else
#error "Define robot type in preprocessor"
#endif


	// Uncomment to clear Bound and Walk behaviors
	behaviors.clear();
	
	behaviors.push_back(&trajBound);

	setDebugRate(100);
	softStartEnable(false);

	SerialPortConfig cfg;
	cfg.baud = 115200;
	cfg.mode = SERIAL_8N1;
	ioctl(STDOUT_FILENO, IOCTL_CMD_SERIAL_PORT_CFG, &cfg);


	// Run
	return begin();
}
