
#include <stdio.h>
#include <SDK.h>
#include <math.h>
#include <Motor.h>
#include <ReorientableBehavior.h>
#include "Interpolator.h"

#if defined(ROBOT_MINITAUR)
// Subject to change for individual robots
// const float motZeros[8] = {2.82, 3.435, 3.54, 3.076, 1.03, 3.08, 6.190, 1.493};
// const float motZeros[8] = {2.570, 2.036, 3.777, 3.853, 2.183, 1.556, .675, 2.679}; // RML Ellie
const float motZeros[8] = {0.93, 5.712, 3.777, 3.853, 2.183, 1.556, .675, 2.679}; // RML Ellie
// const float motZeros[8] = {0.631, 4.076, 1.852, 3.414, 1.817, 5.500, 1.078, 6.252}; //RML Odie
#endif

#define TIMESTEPS 42
#define MOTORS 8

enum TAMode
{
	TA_SIT = 0,
	TA_STAND,
	TA_GO
};

char myData[32];
float* myData_buf = (float*)myData;

// globals for power monitoring values
float voltage, current;
float oldvoltage, oldcurrent;
float power_int = 0;

#pragma pack(push, 1)
// We receive the serial protocol version number (in case we add more fields later)
// our behaviorCmd, and a checksum.
struct SerialCommandPacket
{
	float voltage, current;
};

const char ALIGNMENT_WORD[2] = {'G', 'R'};

#pragma pack(pop)

// // avgAccelerationBrakeLegsMinVel
// float times[TIMESTEPS] = {0.000000,0.012198,0.024397,0.036595,0.048793,0.060992,0.073190,0.085389,0.097587,0.109785,0.121984,0.134182,0.146380,0.158579,0.170777,0.182975,0.195174,0.207372,0.219571,0.231769,0.243967,0.243967,0.245602,0.247237,0.248871,0.250506,0.252141,0.253776,0.255410,0.257045,0.258680,0.260314,0.261949,0.263584,0.265219,0.266853,0.268488,0.270123,0.271757,0.273392,0.275027,0.276662};
// float pos[TIMESTEPS][MOTORS] = {{1.570850,1.570884,1.570891,1.570892,1.570884,1.570851,1.570892,1.570891},{1.583152,1.604076,1.539260,1.560796,1.604076,1.583153,1.560794,1.539259},{1.608851,1.678343,1.460238,1.533047,1.678344,1.608852,1.533042,1.460237},{1.628402,1.750194,1.362864,1.493154,1.750195,1.628403,1.493149,1.362862},{1.634229,1.802455,1.260067,1.442998,1.802457,1.634230,1.442992,1.260064},{1.626997,1.835671,1.154050,1.383084,1.835673,1.626999,1.383077,1.154046},{1.606294,1.850472,1.039784,1.307824,1.850474,1.606296,1.307817,1.039780},{1.571437,1.849530,0.897078,1.197664,1.849534,1.571439,1.197655,0.897072},{1.521766,1.830548,0.723499,1.043712,1.830552,1.521768,1.043700,0.723490},{1.457159,1.786788,0.548123,0.865221,1.786792,1.457160,0.865207,0.548111},{1.374824,1.712069,0.397659,0.688405,1.712073,1.374826,0.688390,0.397642},{1.270980,1.603962,0.275886,0.523021,1.603967,1.270982,0.523010,0.275863},{1.134863,1.450307,0.207226,0.406590,1.450313,1.134865,0.406588,0.207197},{0.933429,1.204963,0.244037,0.404199,1.204969,0.933431,0.404206,0.244011},{0.648925,0.849501,0.334278,0.472133,0.849508,0.648928,0.472139,0.334263},{0.333709,0.479438,0.300337,0.433737,0.479444,0.333712,0.433757,0.300316},{0.207562,0.392499,0.213261,0.386792,0.392498,0.207562,0.386825,0.213229},{0.421607,0.757798,0.320162,0.627340,0.757794,0.421601,0.627357,0.320134},{0.778756,1.274664,0.596990,1.082941,1.274663,0.778751,1.082942,0.596981},{1.101719,1.689736,0.919428,1.534230,1.689738,1.101712,1.534234,0.919423},{1.400456,2.032737,1.235792,1.915351,2.032738,1.400455,1.915353,1.235791},{1.400534,2.032804,1.235886,1.915444,2.032805,1.400533,1.915446,1.235885},{1.440661,2.076987,1.277030,1.961106,2.076988,1.440661,1.961105,1.277030},{1.482419,2.122784,1.318529,2.005969,2.122784,1.482418,2.005970,1.318529},{1.524947,2.169367,1.360496,2.050063,2.169367,1.524947,2.050063,1.360496},{1.567771,2.216277,1.402974,2.093539,2.216277,1.567771,2.093539,1.402974},{1.610681,2.263296,1.446066,2.136435,2.263296,1.610681,2.136434,1.446066},{1.653493,2.310215,1.489820,2.178913,2.310215,1.653493,2.178913,1.489820},{1.696033,2.356825,1.534357,2.221025,2.356825,1.696033,2.221025,1.534357},{1.738127,2.402895,1.579751,2.262942,2.402895,1.738127,2.262942,1.579751},{1.779594,2.448190,1.626148,2.304733,2.448190,1.779594,2.304732,1.626148},{1.820217,2.492418,1.673657,2.346585,2.492418,1.820217,2.346584,1.673657},{1.859758,2.535272,1.722461,2.388594,2.535272,1.859758,2.388593,1.722461},{1.897879,2.576350,1.772717,2.430981,2.576350,1.897879,2.430981,1.772717},{1.934192,2.615218,1.824666,2.473886,2.615218,1.934192,2.473885,1.824666},{1.968144,2.651305,1.878543,2.517593,2.651305,1.968144,2.517593,1.878543},{1.999080,2.683968,1.934683,2.562319,2.683968,1.999080,2.562318,1.934683},{2.026212,2.712444,1.993461,2.608471,2.712444,2.026212,2.608471,1.993462},{2.048675,2.735891,2.055389,2.656418,2.735891,2.048675,2.656417,2.055389},{2.065587,2.753452,2.121124,2.706826,2.753451,2.065587,2.706827,2.121126},{2.075962,2.764089,2.191650,2.760446,2.764088,2.075961,2.760445,2.191652},{2.079403,2.767564,2.268038,2.818472,2.767561,2.079398,2.818478,2.268048}};
// float vel[TIMESTEPS][MOTORS] = {{0.000006,0.000052,0.000094,0.000083,0.000052,0.000006,0.000083,0.000094},{1.788309,4.924792,-4.863698,-1.608745,4.924824,1.788321,-1.608774,-4.863738},{2.173429,6.706109,-7.738005,-2.862385,6.706156,2.173447,-2.862436,-7.738069},{1.028529,5.070382,-8.204030,-3.673417,5.070426,1.028546,-3.673472,-8.204096},{-0.065946,3.512914,-8.651511,-4.566989,3.512956,-0.065929,-4.567051,-8.651580},{-1.140082,1.940606,-8.867725,-5.386913,1.940646,-1.140067,-5.386982,-8.867796},{-2.262802,0.510913,-10.029550,-7.106524,0.510950,-2.262789,-7.106625,-10.029641},{-3.465163,-0.750247,-13.152588,-10.877031,-0.750212,-3.465155,-10.877215,-13.152750},{-4.681630,-2.431894,-15.123734,-14.318807,-2.431861,-4.681624,-14.319033,-15.123993},{-5.973624,-4.809615,-13.490614,-14.753064,-4.809586,-5.973621,-14.753214,-13.490950},{-7.573179,-7.489295,-11.068597,-14.073040,-7.489263,-7.573174,-14.072976,-11.069021},{-9.645995,-10.491437,-8.351777,-12.298262,-10.491397,-9.645984,-12.297714,-8.352323},{-12.852056,-14.941344,-2.381121,-6.065375,-14.941302,-12.852046,-6.064548,-2.381252},{-20.045584,-24.964205,6.806706,4.173417,-24.964173,-20.045579,4.173753,6.807393},{-26.460513,-32.978476,6.378093,5.467530,-32.978354,-26.460378,5.467574,6.378709},{-21.648456,-23.216335,-8.462845,-7.641186,-23.216717,-21.648484,-7.639513,-8.463994},{4.517934,13.431222,-2.311193,4.085860,13.430720,4.517420,4.085724,-2.311285},{26.995059,41.307485,17.776534,31.944973,41.307591,26.994820,31.943041,17.777902},{27.970314,38.276442,25.555847,39.318920,38.276611,27.970501,39.318794,25.556198},{25.228155,30.422932,26.746846,34.392166,30.422963,25.228309,34.392268,26.747103},{23.996124,26.452481,24.537598,27.808474,26.452429,23.996275,27.808497,24.537798},{23.876495,26.390822,25.071225,28.230867,26.390822,23.876495,28.230868,25.071224},{25.116232,27.605634,25.269094,27.701520,27.605634,25.116232,27.701520,25.269094},{25.872732,28.360985,25.515878,27.222898,28.360985,25.872732,27.222898,25.515878},{26.117665,28.626050,25.819850,26.795156,28.626050,26.117665,26.795156,25.819850},{26.234721,28.757706,26.163389,26.427350,28.757706,26.234721,26.427350,26.163389},{26.227009,28.761740,26.552244,26.121478,28.761741,26.227009,26.121478,26.552244},{26.114401,28.634709,26.993393,25.880484,28.634709,26.114401,25.880484,26.993393},{25.894645,28.379677,27.493310,25.707609,28.379677,25.894646,25.707609,27.493310},{25.566214,27.975157,28.061196,25.607386,27.975157,25.566214,25.607386,28.061196},{25.123401,27.421629,28.705604,25.585587,27.421629,25.123401,25.585587,28.705604},{24.531582,26.672419,29.439786,25.649835,26.672419,24.531582,25.649835,29.439786},{23.784891,25.724806,30.276567,25.810386,25.724806,23.784891,25.810386,30.276567},{22.792289,24.502224,31.235378,26.080589,24.502223,22.792289,26.080589,31.235377},{21.548948,22.998688,32.337210,26.478767,22.998688,21.548949,26.478767,32.337210},{19.903094,21.099390,33.613716,27.029526,21.099389,19.903094,27.029526,33.613716},{17.838908,18.790971,35.102470,27.766702,18.790972,17.838908,27.766703,35.102470},{15.253226,15.973865,36.861918,28.740689,15.973864,15.253225,28.740689,36.861918},{12.124634,12.635264,38.967979,30.019826,12.635266,12.124636,30.019826,38.967979},{8.469987,8.768333,41.544209,31.718560,8.768330,8.469984,31.718559,41.544209},{4.215947,4.285519,44.832557,34.027729,4.285523,4.215951,34.027730,44.832559},{0.000001,0.000000,48.746680,37.080712,-0.000001,-0.000002,37.080708,48.746683}};
// float u[TIMESTEPS][MOTORS] = {{0.604008,2.938430,-0.084521,-0.067627,2.938404,0.603982,-0.067602,-0.084516},{0.604008,2.938430,-0.084521,-0.067627,2.938404,0.603982,-0.067602,-0.084516},{-0.077286,-0.049462,0.114000,0.865289,-0.049474,-0.077288,0.865350,0.113999},{-0.077286,-0.049462,0.114000,0.865289,-0.049474,-0.077288,0.865350,0.113999},{-0.078839,-0.057958,0.095042,0.908330,-0.057933,-0.078833,0.908353,0.095030},{-0.078839,-0.057958,0.095042,0.908330,-0.057933,-0.078833,0.908353,0.095030},{-0.081572,-0.065182,-0.073974,0.120629,-0.065225,-0.081584,0.120663,-0.073975},{-0.081572,-0.065182,-0.073974,0.120629,-0.065225,-0.081584,0.120663,-0.073975},{-0.084702,-0.082726,-0.122236,1.246927,-0.082721,-0.084701,1.247004,-0.122298},{-0.084702,-0.082726,-0.122236,1.246927,-0.082721,-0.084701,1.247004,-0.122298},{-0.098201,-0.111440,-0.284627,0.833814,-0.111621,-0.098250,0.833987,-0.284713},{-0.098201,-0.111440,-0.284627,0.833814,-0.111621,-0.098250,0.833987,-0.284713},{-0.153177,-0.223767,-0.179631,0.893484,-0.223809,-0.153187,0.893609,-0.179661},{-0.153177,-0.223767,-0.179631,0.893484,-0.223809,-0.153187,0.893609,-0.179661},{-0.110560,2.113759,-0.480674,0.188332,2.113699,-0.110580,0.188489,-0.480746},{-0.110560,2.113759,-0.480674,0.188332,2.113699,-0.110580,0.188489,-0.480746},{0.544606,2.998757,0.302950,2.780940,2.998795,0.544551,2.781284,0.302856},{0.544606,2.998757,0.302950,2.780940,2.998795,0.544551,2.781284,0.302856},{2.528399,2.998617,2.676587,2.999414,2.998699,2.528537,2.999431,2.676627},{2.528399,2.998617,2.676587,2.999414,2.998699,2.528537,2.999431,2.676627},{2.927861,2.994573,2.998208,2.829190,2.994785,2.928063,2.829305,2.998235},{0.611122,0.882574,2.992800,2.778608,0.882585,0.611113,2.778748,2.992847},{0.611122,0.882574,2.992800,2.778608,0.882585,0.611113,2.778748,2.992847},{0.048830,0.447616,2.993660,2.698379,0.447624,0.048827,2.698522,2.993717},{0.048830,0.447616,2.993660,2.698379,0.447624,0.048827,2.698522,2.993717},{-0.170058,0.296123,2.993365,2.621276,0.296131,-0.170059,2.621423,2.993433},{-0.170058,0.296123,2.993365,2.621276,0.296131,-0.170059,2.621423,2.993433},{-0.361175,0.128359,2.993132,2.545118,0.128365,-0.361174,2.545269,2.993212},{-0.361175,0.128359,2.993132,2.545118,0.128365,-0.361174,2.545269,2.993212},{-0.531544,-0.067413,2.992977,2.464717,-0.067408,-0.531541,2.464871,2.993065},{-0.531544,-0.067413,2.992977,2.464717,-0.067408,-0.531541,2.464871,2.993065},{-0.703159,-0.302890,2.992916,2.373775,-0.302888,-0.703154,2.373928,2.993010},{-0.703159,-0.302890,2.992916,2.373775,-0.302888,-0.703154,2.373928,2.993010},{-0.936345,-0.571448,2.992975,2.262794,-0.571450,-0.936337,2.262940,2.993066},{-0.936345,-0.571448,2.992975,2.262794,-0.571450,-0.936337,2.262940,2.993066},{-1.296369,-0.866545,2.993190,2.115999,-0.866552,-1.296356,2.116129,2.993268},{-1.296369,-0.866545,2.993190,2.115999,-0.866552,-1.296356,2.116129,2.993268},{-1.707186,-1.203427,2.993638,1.904265,-1.203443,-1.707167,1.904369,2.993691},{-1.707186,-1.203427,2.993638,1.904265,-1.203443,-1.707167,1.904369,2.993691},{-2.055898,-1.569667,2.994502,1.559784,-1.569695,-2.055873,1.559856,2.994521},{-2.055898,-1.569667,2.994502,1.559784,-1.569695,-2.055873,1.559856,2.994521},{-1.996268,-1.426926,1.387126,0.190282,-1.426998,-1.996298,0.190298,1.387088}};
// float dfVec[TIMESTEPS][MOTORS] = {{0.117911,0.573625,-0.016499,-0.013201,0.573620,0.117906,-0.013196,-0.016498},{0.131725,0.611667,-0.054070,-0.025629,0.611662,0.131720,-0.025624,-0.054070},{0.001702,0.042147,-0.037519,0.146806,0.042145,0.001701,0.146818,-0.037520},{-0.007142,0.029511,-0.041119,0.140541,0.029510,-0.007143,0.140553,-0.041120},{-0.015900,0.015822,-0.048277,0.142041,0.015827,-0.015899,0.142045,-0.048280},{-0.024197,0.003676,-0.049947,0.135707,0.003682,-0.024196,0.135711,-0.049950},{-0.033404,-0.008778,-0.091916,-0.031347,-0.008786,-0.033406,-0.031341,-0.091917},{-0.042691,-0.018520,-0.116040,-0.060473,-0.018528,-0.042694,-0.060468,-0.116042},{-0.052699,-0.034935,-0.140688,0.132810,-0.034934,-0.052699,0.132823,-0.140703},{-0.062680,-0.053302,-0.128073,0.129456,-0.053301,-0.062679,0.129469,-0.128088},{-0.077671,-0.079607,-0.141065,0.054063,-0.079642,-0.077680,0.054097,-0.141085},{-0.093683,-0.102798,-0.120078,0.067772,-0.102833,-0.093692,0.067810,-0.120099},{-0.129181,-0.159100,-0.053460,0.127568,-0.159108,-0.129183,0.127599,-0.053467},{-0.184748,-0.236524,0.017513,0.206660,-0.236531,-0.184750,0.206687,0.017513},{-0.225982,0.157888,-0.044566,0.079000,0.157877,-0.225985,0.079031,-0.044575},{-0.188811,0.233298,-0.159208,-0.022261,0.233283,-0.188815,-0.022217,-0.159230},{0.141215,0.689154,0.041287,0.574442,0.689157,0.141200,0.574508,0.041268},{0.314844,0.904489,0.196459,0.789646,0.904497,0.314831,0.789698,0.196451},{0.709643,0.881048,0.719920,0.889256,0.881065,0.709671,0.889259,0.719931},{0.688461,0.820382,0.729120,0.851199,0.820398,0.688489,0.851203,0.729130},{0.756924,0.788922,0.774840,0.767112,0.788963,0.756965,0.767134,0.774847},{0.303739,0.376153,0.777906,0.760500,0.376155,0.303737,0.760527,0.777915},{0.313315,0.385537,0.779435,0.756411,0.385539,0.313313,0.756438,0.779444},{0.209391,0.306461,0.781509,0.737052,0.306463,0.209391,0.737080,0.781520},{0.211283,0.308509,0.783857,0.733748,0.308510,0.211283,0.733775,0.783868},{0.169457,0.279952,0.786453,0.715855,0.279954,0.169457,0.715884,0.786466},{0.169398,0.279983,0.789457,0.713492,0.279985,0.169398,0.713521,0.789470},{0.131219,0.246252,0.792819,0.696763,0.246253,0.131219,0.696793,0.792835},{0.129522,0.244282,0.796681,0.695428,0.244283,0.129522,0.695457,0.796696},{0.093726,0.202940,0.801037,0.678958,0.202941,0.093727,0.678988,0.801055},{0.090306,0.198664,0.806015,0.678790,0.198665,0.090306,0.678820,0.806032},{0.052232,0.146908,0.811675,0.661533,0.146908,0.052233,0.661563,0.811693},{0.046464,0.139588,0.818139,0.662773,0.139588,0.046465,0.662803,0.818157},{-0.006725,0.077717,0.825557,0.643195,0.077717,-0.006723,0.643224,0.825574},{-0.016329,0.066103,0.834068,0.646271,0.066103,-0.016328,0.646300,0.834086},{-0.099325,-0.006176,0.843970,0.621869,-0.006177,-0.099322,0.621894,0.843986},{-0.115270,-0.024008,0.855471,0.627563,-0.024009,-0.115268,0.627589,0.855486},{-0.215441,-0.111533,0.869149,0.593754,-0.111537,-0.215438,0.593774,0.869160},{-0.239609,-0.137323,0.885418,0.603635,-0.137326,-0.239605,0.603655,0.885428},{-0.335913,-0.238689,0.905487,0.549509,-0.238695,-0.335909,0.549523,0.905491},{-0.368775,-0.273318,0.930889,0.567347,-0.273323,-0.368770,0.567361,0.930892},{-0.389701,-0.278557,0.647341,0.323583,-0.278571,-0.389707,0.323586,0.647333}};

// avgAccelerationBrakeLegsMinVelMinGRFMu06
float times[TIMESTEPS] = {0.000000,0.011746,0.023491,0.035237,0.046983,0.058729,0.070474,0.082220,0.093966,0.105712,0.117457,0.129203,0.140949,0.152695,0.164440,0.176186,0.187932,0.199678,0.211423,0.223169,0.234915,0.234915,0.236448,0.237980,0.239513,0.241046,0.242578,0.244111,0.245644,0.247176,0.248709,0.250242,0.251774,0.253307,0.254840,0.256372,0.257905,0.259438,0.260970,0.262503,0.264036,0.265568};
float pos[TIMESTEPS][MOTORS] = {{1.570887,1.570887,1.570835,1.570864,1.570887,1.570887,1.570864,1.570836},{1.568584,1.573178,1.561697,1.566352,1.573176,1.568584,1.566353,1.561698},{1.560321,1.577453,1.535185,1.552452,1.577453,1.560321,1.552453,1.535186},{1.544526,1.580023,1.492960,1.528807,1.580022,1.544526,1.528808,1.492961},{1.519990,1.578503,1.435460,1.494638,1.578503,1.519990,1.494639,1.435461},{1.486481,1.572124,1.362545,1.449255,1.572124,1.486481,1.449256,1.362545},{1.443277,1.559784,1.273020,1.390772,1.559784,1.443276,1.390773,1.273020},{1.390021,1.540659,1.166385,1.317929,1.540659,1.390021,1.317929,1.166384},{1.325410,1.513449,1.036026,1.222648,1.513449,1.325410,1.222649,1.036026},{1.247887,1.477542,0.858508,1.077575,1.477543,1.247886,1.077577,0.858508},{1.155149,1.427219,0.638319,0.878165,1.427219,1.155147,0.878166,0.638323},{1.045012,1.353058,0.450658,0.701396,1.353059,1.045006,0.701394,0.450658},{0.909445,1.245375,0.344252,0.610431,1.245375,0.909444,0.610432,0.344253},{0.727621,1.082394,0.280991,0.567988,1.082395,0.727620,0.567989,0.280991},{0.495913,0.864708,0.220345,0.537980,0.864708,0.495913,0.537984,0.220343},{0.231011,0.625320,0.115498,0.486582,0.625321,0.231010,0.486588,0.115493},{0.064394,0.535759,0.061877,0.538462,0.535760,0.064394,0.538465,0.061873},{0.156224,0.789784,0.224726,0.876652,0.789786,0.156215,0.876649,0.224724},{0.436356,1.262984,0.516707,1.349639,1.262985,0.436357,1.349638,0.516707},{0.762197,1.733377,0.814409,1.776453,1.733375,0.762199,1.776450,0.814411},{1.068092,2.123698,1.100180,2.141339,2.123699,1.068093,2.141339,1.100178},{1.068175,2.123780,1.100229,2.141366,2.123782,1.068176,2.141371,1.100220},{1.105124,2.169249,1.137077,2.185094,2.169250,1.105124,2.185095,1.137075},{1.142117,2.216266,1.174305,2.228088,2.216267,1.142117,2.228089,1.174304},{1.178482,2.264056,1.211987,2.270408,2.264056,1.178482,2.270407,1.211986},{1.213994,2.312134,1.250189,2.312135,2.312134,1.213994,2.312135,1.250189},{1.248740,2.360227,1.288978,2.353349,2.360227,1.248740,2.353349,1.288978},{1.282797,2.408064,1.328424,2.394143,2.408064,1.282797,2.394142,1.328424},{1.316250,2.455379,1.368608,2.434600,2.455379,1.316250,2.434599,1.368608},{1.349151,2.501889,1.409622,2.474823,2.501889,1.349151,2.474822,1.409622},{1.381552,2.547302,1.451567,2.514905,2.547302,1.381552,2.514904,1.451567},{1.413412,2.591304,1.494559,2.554963,2.591304,1.413412,2.554962,1.494559},{1.444666,2.633570,1.538729,2.595108,2.633570,1.444666,2.595108,1.538729},{1.475087,2.673726,1.584227,2.635485,2.673726,1.475087,2.635484,1.584227},{1.504379,2.711377,1.631227,2.676235,2.711377,1.504379,2.676234,1.631227},{1.532057,2.746025,1.679936,2.717546,2.746025,1.532057,2.717546,1.679937},{1.557533,2.777115,1.730599,2.759616,2.777115,1.557533,2.759615,1.730599},{1.580085,2.803996,1.783523,2.802718,2.803996,1.580085,2.802718,1.783523},{1.598916,2.825953,1.839075,2.847154,2.825953,1.598916,2.847153,1.839075},{1.613200,2.842286,1.897751,2.893370,2.842284,1.613200,2.893371,1.897753},{1.621979,2.852172,1.960243,2.941922,2.852171,1.621979,2.941921,1.960244},{1.624886,2.855410,2.027215,2.993567,2.855404,1.624885,2.993571,2.027221}};
float vel[TIMESTEPS][MOTORS] = {{0.000056,0.000062,0.000002,0.000023,0.000061,0.000057,0.000023,0.000004},{-0.431443,0.324352,-1.540380,-0.782108,0.324353,-0.431442,-0.782108,-1.540380},{-0.996159,0.356519,-2.953410,-1.590738,0.356519,-0.996159,-1.590738,-2.953412},{-1.715145,0.052909,-4.243122,-2.453552,0.052910,-1.715144,-2.453551,-4.243122},{-2.466631,-0.322319,-5.550728,-3.376118,-0.322319,-2.466632,-3.376118,-5.550730},{-3.261571,-0.789468,-6.891077,-4.390945,-0.789467,-3.261571,-4.390944,-6.891077},{-4.101810,-1.322123,-8.376198,-5.601290,-1.322122,-4.101811,-5.601290,-8.376199},{-4.999983,-1.961499,-9.935067,-6.983115,-1.961499,-4.999984,-6.983114,-9.935067},{-6.022412,-2.686198,-12.413551,-9.417444,-2.686197,-6.022414,-9.417443,-12.413551},{-7.219547,-3.555987,-17.370874,-14.977198,-3.555985,-7.219547,-14.977199,-17.370875},{-8.603532,-5.131736,-19.676171,-18.665269,-5.131736,-8.603534,-18.665269,-19.676168},{-10.308737,-7.622102,-12.398918,-11.418455,-7.622101,-10.308736,-11.418455,-12.398916},{-12.932065,-10.841993,-5.857018,-4.060912,-10.841991,-12.932063,-4.060915,-5.857020},{-17.818730,-16.560649,-5.093252,-3.127865,-16.560652,-17.818734,-3.127861,-5.093251},{-21.429785,-20.158764,-5.412869,-1.942091,-20.158764,-21.429778,-1.942093,-5.412868},{-21.026677,-17.305175,-9.592038,-3.395581,-17.305175,-21.026673,-3.395580,-9.592037},{-4.697446,5.344763,3.312837,15.638526,5.344763,-4.697447,15.638524,3.312836},{18.081159,34.431347,21.889359,38.235433,34.431348,18.081156,38.235433,21.889357},{27.356199,42.651376,25.295225,38.594998,42.651376,27.356196,38.594999,25.295223},{27.504651,37.038409,25.115889,33.888996,37.038409,27.504655,33.888994,25.115890},{23.956938,29.010651,23.256298,28.051221,29.010650,23.956936,28.051221,23.256299},{23.964423,29.001268,23.937079,28.792543,29.001268,23.964423,28.792544,23.937080},{24.181335,30.249469,24.158726,28.290082,30.249469,24.181335,28.290083,24.158726},{24.020590,31.022110,24.427112,27.831464,31.022109,24.020590,27.831464,24.427112},{23.435149,31.304732,24.747663,27.415470,31.304732,23.435149,27.415470,24.747663},{22.909444,31.400312,25.108368,27.054234,31.400312,22.909444,27.054234,25.108368},{22.432972,31.324945,25.512911,26.748952,31.324945,22.432972,26.748952,25.512911},{22.013266,31.067097,25.967813,26.501436,31.067097,22.013266,26.501436,25.967813},{21.639041,30.640818,26.477628,26.314330,30.640818,21.639041,26.314330,26.477628},{21.293387,30.017478,27.050980,26.190779,30.017478,21.293387,26.190779,27.050980},{20.971788,29.206386,27.694558,26.135743,29.206386,20.971788,26.135743,27.694558},{20.589778,28.176571,28.418689,26.154829,28.176571,20.589778,26.154830,28.418689},{20.153604,26.932892,29.233791,26.256745,26.932893,20.153604,26.256745,29.233791},{19.502914,25.422289,30.154537,26.451068,25.422289,19.502914,26.451068,30.154536},{18.649036,23.647142,31.197588,26.752741,23.647142,18.649036,26.752741,31.197588},{17.398731,21.504806,32.388275,27.179162,21.504806,17.398731,27.179162,32.388275},{15.752392,18.987549,33.755486,27.756394,18.987549,15.752393,27.756394,33.755486},{13.586559,16.013940,35.342548,28.520909,16.013939,13.586558,28.520909,35.342548},{10.890794,12.564522,37.204734,29.521889,12.564524,10.890795,29.521890,37.204734},{7.658294,8.674419,39.423991,30.839521,8.674418,7.658291,30.839520,39.423991},{3.802079,4.253261,42.177284,32.602893,4.253261,3.802087,32.602894,42.177286},{0.000003,0.000000,45.272116,34.867717,0.000000,-0.000001,34.867714,45.272117}};
float u[TIMESTEPS][MOTORS] = {{-0.115177,0.835209,-0.123114,0.920260,0.884847,-0.117090,0.870796,-0.121181},{-0.115177,0.835209,-0.123114,0.920260,0.884847,-0.117090,0.870796,-0.121181},{-0.101723,0.508109,-0.122747,0.841570,0.516526,-0.102009,0.833439,-0.122420},{-0.101723,0.508109,-0.122747,0.841570,0.516526,-0.102009,0.833439,-0.122420},{-0.097785,0.441906,-0.138210,0.901221,0.443352,-0.097830,0.899949,-0.138154},{-0.097785,0.441906,-0.138210,0.901221,0.443352,-0.097830,0.899949,-0.138154},{-0.096861,0.407847,-0.176132,0.919360,0.408141,-0.096872,0.919172,-0.176127},{-0.096861,0.407847,-0.176132,0.919360,0.408141,-0.096872,0.919172,-0.176127},{-0.098558,0.365664,-0.199033,0.295572,0.365801,-0.098565,0.295537,-0.199032},{-0.098558,0.365664,-0.199033,0.295572,0.365801,-0.098565,0.295537,-0.199032},{-0.126254,0.290476,-1.204857,2.987046,0.290261,-0.126249,2.987273,-1.204991},{-0.126254,0.290476,-1.204857,2.987046,0.290261,-0.126249,2.987273,-1.204991},{-0.157756,0.140350,-0.408604,0.673830,0.140362,-0.157763,0.673842,-0.408624},{-0.157756,0.140350,-0.408604,0.673830,0.140362,-0.157763,0.673842,-0.408624},{-0.417610,1.394049,-0.506213,0.778543,1.393832,-0.417539,0.778708,-0.506346},{-0.417610,1.394049,-0.506213,0.778543,1.393832,-0.417539,0.778708,-0.506346},{0.172369,2.608505,0.161758,2.996824,2.608648,0.172353,2.996772,0.161719},{0.172369,2.608505,0.161758,2.996824,2.608648,0.172353,2.996772,0.161719},{2.994352,2.995765,2.987830,2.997577,2.995211,2.993839,2.997404,2.989125},{2.994352,2.995765,2.987830,2.997577,2.995211,2.993839,2.997404,2.989125},{2.495152,1.962995,0.277453,0.098729,-0.353925,-0.220618,2.499022,2.995612},{-0.116675,1.164963,2.973482,2.414720,1.164970,-0.116676,2.415329,2.973423},{-0.116675,1.164963,2.973482,2.414720,1.164970,-0.116676,2.415329,2.973423},{-0.603552,0.724456,2.975161,2.312324,0.724461,-0.603547,2.312862,2.975125},{-0.603552,0.724456,2.975161,2.312324,0.724461,-0.603547,2.312862,2.975125},{-0.564770,0.451171,2.974162,2.212184,0.451175,-0.564766,2.212760,2.974135},{-0.564770,0.451171,2.974162,2.212184,0.451175,-0.564766,2.212760,2.974135},{-0.477937,0.121882,2.973412,2.115237,0.121885,-0.477935,2.115847,2.973395},{-0.477937,0.121882,2.973412,2.115237,0.121885,-0.477935,2.115847,2.973395},{-0.360985,-0.276216,2.972988,2.017433,-0.276213,-0.360984,2.018064,2.972980},{-0.360985,-0.276216,2.972988,2.017433,-0.276213,-0.360984,2.018064,2.972980},{-0.318170,-0.698854,2.972998,1.913420,-0.698852,-0.318169,1.914048,2.972996},{-0.318170,-0.698854,2.972998,1.913420,-0.698852,-0.318169,1.914048,2.972996},{-0.473228,-1.105680,2.973558,1.796336,-1.105682,-0.473224,1.796928,2.973558},{-0.473228,-1.105680,2.973558,1.796336,-1.105682,-0.473224,1.796928,2.973558},{-0.860555,-1.522177,2.974733,1.657627,-1.522185,-0.860545,1.658140,2.974731},{-0.860555,-1.522177,2.974733,1.657627,-1.522185,-0.860545,1.658140,2.974731},{-1.381287,-1.949354,2.976220,1.483100,-1.949366,-1.381272,1.483497,2.976209},{-1.381287,-1.949354,2.976220,1.483100,-1.949366,-1.381272,1.483497,2.976209},{-1.939862,-2.291620,2.976149,1.246385,-2.291654,-1.939827,1.246641,2.976140},{-1.939862,-2.291620,2.976149,1.246385,-2.291654,-1.939827,1.246641,2.976140},{-1.837577,-2.165180,1.050956,0.186108,-2.165175,-1.837687,0.186116,1.050930}};
float dfVec[TIMESTEPS][MOTORS] = {{-0.022484,0.163046,-0.024034,0.179648,0.172736,-0.022857,0.169992,-0.023656},{-0.025817,0.165551,-0.035933,0.173607,0.175241,-0.026190,0.163951,-0.035555},{-0.027553,0.101944,-0.046776,0.151999,0.103588,-0.027609,0.150412,-0.046712},{-0.033107,0.099599,-0.056739,0.145334,0.101242,-0.033163,0.143747,-0.056675},{-0.038143,0.083777,-0.069858,0.149852,0.084059,-0.038152,0.149604,-0.069847},{-0.044284,0.080168,-0.080212,0.142013,0.080450,-0.044292,0.141765,-0.080201},{-0.050594,0.069405,-0.099087,0.136204,0.069462,-0.050596,0.136168,-0.099086},{-0.057532,0.064466,-0.111129,0.125530,0.064523,-0.057534,0.125494,-0.111128},{-0.065761,0.050633,-0.134745,-0.015047,0.050660,-0.065763,-0.015054,-0.134745},{-0.075009,0.043914,-0.173039,-0.057994,0.043941,-0.075010,-0.058001,-0.173039},{-0.091106,0.017064,-0.387198,0.438932,0.017022,-0.091105,0.438976,-0.387224},{-0.104278,-0.002173,-0.330984,0.494911,-0.002215,-0.104278,0.494956,-0.331010},{-0.130693,-0.056353,-0.125009,0.100172,-0.056350,-0.130694,0.100174,-0.125013},{-0.168441,-0.100528,-0.119109,0.107380,-0.100525,-0.168442,0.107382,-0.119113},{-0.247062,0.116418,-0.140633,0.136981,0.116376,-0.247048,0.137013,-0.140659},{-0.243948,0.138462,-0.172916,0.125753,0.138419,-0.243934,0.125785,-0.172942},{-0.002637,0.550505,0.057168,0.705827,0.550533,-0.002641,0.705817,0.057161},{0.173320,0.775190,0.200666,0.880381,0.775218,0.173317,0.880371,0.200659},{0.795860,0.914286,0.778666,0.883306,0.914178,0.795760,0.883272,0.778919},{0.797007,0.870928,0.777281,0.846953,0.870820,0.796907,0.846919,0.777534},{0.672150,0.607304,0.233811,0.235961,0.155007,0.141992,0.704533,0.764435},{0.162341,0.451444,0.765374,0.693802,0.451445,0.162341,0.693921,0.765362},{0.164017,0.461086,0.767086,0.689921,0.461087,0.164017,0.690040,0.767075},{0.067730,0.381061,0.769487,0.666389,0.381062,0.067730,0.666494,0.769480},{0.063207,0.383244,0.771963,0.663176,0.383245,0.063208,0.663281,0.771956},{0.066717,0.330633,0.774555,0.640837,0.330634,0.066718,0.640949,0.774549},{0.063036,0.330051,0.777680,0.638478,0.330052,0.063037,0.638591,0.777674},{0.076745,0.263777,0.781047,0.617641,0.263778,0.076746,0.617760,0.781044},{0.073855,0.260484,0.784985,0.616196,0.260485,0.073855,0.616315,0.784982},{0.094015,0.177955,0.789332,0.596148,0.177955,0.094016,0.596271,0.789330},{0.091531,0.171689,0.794303,0.595723,0.171690,0.091531,0.595846,0.794301},{0.096938,0.081229,0.799899,0.575566,0.081229,0.096939,0.575688,0.799898},{0.093569,0.071622,0.806195,0.576353,0.071622,0.093569,0.576476,0.806195},{0.058273,-0.019466,0.813417,0.554998,-0.019466,0.058274,0.555113,0.813417},{0.051677,-0.033178,0.821474,0.557328,-0.033178,0.051678,0.557444,0.821474},{-0.033593,-0.131033,0.830901,0.533544,-0.131035,-0.033591,0.533644,0.830901},{-0.046311,-0.150478,0.841463,0.538003,-0.150480,-0.046309,0.538103,0.841462},{-0.164695,-0.256840,0.854012,0.509838,-0.256842,-0.164693,0.509916,0.854010},{-0.185519,-0.283486,0.868397,0.517571,-0.283488,-0.185516,0.517648,0.868395},{-0.319532,-0.380351,0.885526,0.481539,-0.380357,-0.319525,0.481589,0.885525},{-0.349320,-0.414503,0.906795,0.495160,-0.414509,-0.349313,0.495210,0.906793},{-0.358722,-0.422675,0.554875,0.305674,-0.422674,-0.358744,0.305675,0.554870}};


class TrajAccelerate : public ReorientableBehavior
{
public:
	Interpolator interp;

	TAMode mode = TA_SIT; //Current state within state-machine
	int logging = 0;

	uint32_t tLast; //int used to store system time at various events

	float extDes; //The desired leg extension
	float angDes; // The desired leg angle
	float t;
	uint32_t tOld;
	uint32_t tNew;
	uint32_t timeStep;
	uint32_t iter = 0;

	bool boolSlow = false;

	float posDes[MOTORS];
	float velDes[MOTORS];
	float uDes[MOTORS];
	float df[MOTORS];
	float dfDes[MOTORS];
	float posAct;
	float velAct;
	float kp = 0.8; // 0.80
	float kd = 0.020; // 0.02
	float kpy = 0.1;	//0.1;
	float kdy = 0;		//0.05;
	float kiy = 0.02;
	float V = 15;
	float R = 0.22;
	float kt = 0.0954;
	float yawErrorInt = 0;

	float yawInit;
	float yawDes;
	float turnLeft;

	float finalTime = times[TIMESTEPS - 1];

	// Parser state (for serial comms with raspi)
	// Goes from 0 to 1 to 2
	int numAlignmentSeen = 0;
	uint16_t rxPtr = 0;

	// Receive buffer and alignment
	const static uint16_t RX_BUF_SIZE = 100;
	SerialCommandPacket packet;

	//sig is mapped from remote; here, 3 corresponds to pushing the left stick to the right
	// which in turn forces the state machine into FH_LEAP
	void signal(uint32_t sig)
	{
		// tLast = S->millis;
		if (logging == 0) power_int = 0;
		// logging = 1;
		if (mode == TA_STAND)
		{
			mode = TA_GO;			// Start behavior in STAND mode
			tLast = S->millis;
		}	
	}

	void begin()
	{
		mode = TA_STAND;			// Start behavior in STAND mode
		tLast = S->millis;		// Record the system time @ this transition
		yawInit = S->imu.euler.z;
		yawErrorInt = 0;
		power_int = 0;
		// ioctl(LOGGER_FILENO, 0);//stop
	}

	void update()
	{
		tOld = tNew;
		tNew = clockTimeUS;
		timeStep = tNew - tOld;
		// if (tNew!=clockTimeUS)
		// {
		// 	tOld = tNew;
		// 	tNew = clockTimeUS;
		// 	timeStep = tNew - tOld;
		// }


		// Serial comms code
		oldvoltage = voltage;
		oldcurrent = current;

		// Character to store the latest received character
		uint8_t latestRX;

		// Loop through while there are new bytes available
		while (read(SERIAL_AUX_FILENO, &latestRX, 1) > 0)
		{
			if (numAlignmentSeen == 0 && latestRX == ALIGNMENT_WORD[0])
			{
				numAlignmentSeen = 1;
			}
			else if (numAlignmentSeen == 1 && latestRX == ALIGNMENT_WORD[1])
			{
				numAlignmentSeen = 2;
				rxPtr = 0;
			}
			else if (numAlignmentSeen == 2)
			{
				// Add the next byte to our memory space in serial_packet
				uint8_t *pSerialPacket = (uint8_t *)&packet;
				pSerialPacket[rxPtr++] = latestRX; // post-increment rxPtr

				// Check if we have read a whole packet
				if (rxPtr == sizeof(SerialCommandPacket))
				{
					// Copy voltage and current readings
					voltage = packet.voltage;
					current = packet.current;

					// Reset
					numAlignmentSeen = rxPtr = 0;
				}
			}
		}

		if (isReorienting())
			return;

		for (int j = 0; j < MOTORS; j++)
		{
			posDes[j] = 0;
			velDes[j] = 0;
			uDes[j] = 0;
			df[j] = 0;
		}

		if (mode == TA_SIT)
		{


			C->mode = RobotCommand_Mode_JOINT;
			for (int i = 0; i < P->joints_count; i++)
			{
				posDes[i] = 0.5;
				// Splay angle for the front/rear legs (outward splay due to fore-displacement of front legs
				// and aft-displacement of rear legs)
				// The pitch angle (S->imu.euler.y) is subtracted since we want to the set the *absolute* leg angle
				// and limb[i].setPosition(ANGLE, *) will set the angle of the leg *relative* to the robot body
				if(i==1 || i==3 || i==4 || i==6)
				{
					posDes[i] = posDes[i] - S->imu.euler.y;
				} else if(i==0 || i==2 || i==5 || i==7)
				{
					posDes[i] = posDes[i] + S->imu.euler.y;
				}

				joint[i].setGain(0.8, .003);
				joint[i].setPosition(posDes[i]);
			}
		}
		else if (mode == TA_STAND)
		{


			C->mode = RobotCommand_Mode_JOINT;
			for (int i = 0; i < P->joints_count; i++)
			{
				posDes[i] = 0.5;
				// Splay angle for the front/rear legs (outward splay due to fore-displacement of front legs
				// and aft-displacement of rear legs)
				// The pitch angle (S->imu.euler.y) is subtracted since we want to the set the *absolute* leg angle
				// and limb[i].setPosition(ANGLE, *) will set the angle of the leg *relative* to the robot body
				if(i==1 || i==3 || i==4 || i==6)
				{
					posDes[i] = pos[0][i] - S->imu.euler.y;
				} else if(i==0 || i==2 || i==5 || i==7)
				{
					posDes[i] = pos[0][i] + S->imu.euler.y;
				}

				joint[i].setGain(0.8, .003);
				joint[i].setPosition(posDes[i]);
			}
		}
		else if (mode == TA_GO)
		{
			if (voltage<10)
			{
				voltage = oldvoltage;
				current = oldcurrent;
			}
			power_int = power_int + 0.000001*timeStep*(voltage + oldvoltage)*0.5*(current + oldcurrent)*0.5;

			C->mode = RobotCommand_Mode_JOINT;

			// t = 0.00001 * (100 * (S->millis - tLast) % (int)(100000 * finalTime));
			t = 0.001*(S->millis - tLast);

			int index = 0;
			for (int j = 0; j < TIMESTEPS; j++)
			{
				if (times[j] <= t && t < times[j + 1])
				{
					index = j;
				}
			}

			interp.getMultipleCubicSplineInterp(pos, vel, times, t, posDes);
			interp.getMultipleLinearInterp(vel, times, t, velDes);
			interp.getMultipleZOH(u, times, t, uDes);
			// interp.getMultipleZOH(dfVec, times, t, dfDes);

			for (int i = 0; i < MOTORS; ++i)
			{

				// int ii;
				// if (i==0)
				// {
				// 	ii = 1;
				// } else if (i == 1) {
				// 	ii = 0;
				// } else {
				// 	ii = i;
				// }
				// joint[i].setGain(0.8);

				// yawDes = yawInit + 0;
				// yawErrorInt = yawErrorInt + 0.001 * (yawDes - S->imu.euler.z);
				// turnLeft = kpy*(yawDes - S->imu.euler.z) + kdy*(-S->imu.angular_velocity.z) + 0.1;
				turnLeft = -map(C->behavior.twist.angular.z, -1.0, 1.0, -0.1, 0.1) - 0.03;

				if (i == 0 || i == 2 || i == 4 || i == 6)
				{
					posDes[i] = posDes[i] - turnLeft;
				}
				else if (i == 1 || i == 3 || i == 5 || i == 7)
				{
					posDes[i] = posDes[i] + turnLeft;
				}

				// if(i==1 || i==3 || i==4 || i==6)
				// {
				// 	posDes[i] = posDes[i] - S->imu.euler.y;
				// } else if(i==0 || i==2 || i==5 || i==7)
				// {
				// 	posDes[i] = posDes[i] + S->imu.euler.y;
				// }

				posAct = joint[i].getPosition();
				velAct = joint[i].getVelocity();

				df[i] = 1 / (0.95 * S->batt.voltage) * (uDes[i] * R / kt + kt * joint[i].getVelocity());
				joint[i].setOpenLoop(df[i] + kp * (posDes[i] - posAct) + kd * (velDes[i] - velAct));
				// joint[i].setOpenLoop(dfDes[i] + kp * (posDes[i] - posAct) + kd * (velDes[i] - velAct));

				if (t>=times[TIMESTEPS-1])
				{
					mode = TA_SIT;
					tLast = S->millis;
					t = 0;
				}
			}
		}
	}

	bool running()
	{
		return false;
	}
	void end()
	{
		mode = TA_SIT;
		logging = 0;
	}
};

TrajAccelerate trajAccelerate;

void debug()
{
	// printf("loop: ");
	printf("%d, ", trajAccelerate.mode);
	// printf("pos command: %4.3f, %4.3f, %4.3f, %4.3f, %4.3f, %4.3f, %4.3f, %4.3f. ",
	// 	trajAccelerate.uDes[0],trajAccelerate.uDes[1],trajAccelerate.uDes[2],trajAccelerate.uDes[3],trajAccelerate.uDes[4],trajAccelerate.uDes[5],trajAccelerate.uDes[6],trajAccelerate.uDes[7]);
	printf("Time: %4.3fs. ", trajAccelerate.t);
	// printf("%4.3f, %4.3f, %4.3f ", trajAccelerate.yawInit, trajAccelerate.turnLeft, trajAccelerate.kiy * trajAccelerate.yawErrorInt);
	// printf("test1, test2: %4.3f, %4.3f.", trajAccelerate.test1,trajAccelerate.test2);
	// printf("Voltage: %6.3f, Current: %6.3f", voltage,  current);

	// for (int i = 0; i < P->joints_count; i++)
	// {
	// 	printf("Motor %d, Pos: %4.3f, ", i, joint[i].getRawPosition());
	// }


	// printf("Power Int: %6.2f, Voltage: %5.2f, Current: %5.2f", power_int, voltage, current);
	printf("\n");

	// myData_buf[0] = trajAccelerate.logging;
	// myData_buf[1] = voltage;
	// myData_buf[2] = current;
	// myData_buf[3] = power_int;
	// write(LOGGER_FILENO, myData, 32);
}

int main(int argc, char *argv[])
{
#if defined(ROBOT_MINITAUR)
	init(RobotParams_Type_MINITAUR, argc, argv);
	for (int i = 0; i < P->joints_count; ++i)
		P->joints[i].zero = motZeros[i]; //Add motor zeros from array at beginning of file
#elif defined(ROBOT_MINITAUR_E)
	init(RobotParams_Type_MINITAUR_E, argc, argv);
	JoyType joyType = JoyType_FRSKY_XSR;
	ioctl(JOYSTICK_FILENO, IOCTL_CMD_JOYSTICK_SET_TYPE, &joyType);
#else
#error "Define robot type in preprocessor"
#endif


	// Uncomment to clear Accelerate and Walk behaviors
	// behaviors.clear();
	
	behaviors.push_back(&trajAccelerate);

	setDebugRate(100);
	safetyShutoffEnable(false);

	SerialPortConfig cfg;
	cfg.baud = 115200;
	cfg.mode = SERIAL_8N1;
	ioctl(STDOUT_FILENO, IOCTL_CMD_SERIAL_PORT_CFG, &cfg);


	// Run
	return begin();
}